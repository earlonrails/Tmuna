<!doctype html>
<html>
<!--
Tmuna (תמונה, Hebrew for "picture") is an open-sourced free HTML5 drawing application.
    Copyright (C) 2010  Elad Alfassa <elad@fedoraproject.org>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

Github: https://github.com/elad661/Tmuna
!-->
	<head>
		<meta charset="utf-8">
		<title>תמונה: תוכנת ציור בHTML5</title>
		<link rel="stylesheet" type="text/css" href="Tmuna.css" />
		<script type="text/javascript">
				var canvas;
				var ctx;
				var pointarray=new Array();
				var dotindex=0, dotgrab=false;
				var i=0;
				var image, ptool;
				var Text;
				var x=0, y=0;
				var x1=-1, y1=-1;
				var Tool="Line";
				var mousedown=false;
				function init() {
			    	canvas = document.getElementById('canvas');
					TempLayer = document.getElementById('TempLayer'); 
					canvas.width=window.innerWidth-25;
					TempLayer.width=window.innerWidth-25;
					canvas.height=window.innerHeight-86;
					TempLayer.height=window.innerHeight-86;
  					if (canvas.getContext){	
 						ctx = canvas.getContext('2d');
						ctx2 = TempLayer.getContext('2d');
					} else {  
  						alert("אתה צריך דפדפן עדכני בשביל זה. מה, אתה גולש באקספלורר? איזה דביל! או שתחליף דפדפן או שתעוף מכאן. בחירה שלך."); 
					}
					SelectTool("FreeLine");
					document.addEventListener("touchstart", touchHandler, true);
					document.addEventListener("touchmove", touchHandler, true);
					document.addEventListener("touchend", touchHandler, true);
					document.addEventListener("touchcancel", touchHandler, true);
					Load();
					canvas.onmouseout = function(e) {
						x1=-1;
						mousedown=false;
						canvas.style.cursor="";
						document.getElementById('position').innerHTML="Out";
						ClearTemp();		
					}
					canvas.onmousemove = function(e) {
						canvas.style.cursor="";
						ClearTemp();
						UpdateSettings();
						SaveSettings();
						if (e.offsetX) { x = e.offsetX; y = e.offsetY; }
						else if (e.layerX) { x = e.layerX; y = e.layerY }
						document.getElementById('position').innerHTML="X: " + x+", Y: " +y;
						document.getElementById('tool').innerHTML=Tool;
						if (x1!=-1) {	
							switch(Tool) {					
								case "FreeLine":
									DrawLine(x1, y1, x,y);
									x1=x; y1=y;
								break;
								case "Line":
									DrawTempLine(x1, y1, x,y);
								break;
								case "Circle":
									DrawTempCircle(x1, y1, x, y);
								break;
								case "Rect":
									DrawTempRect(x1, y1, x, y);
								break;
								case "Triangle":
									DrawTempTriangle(x1, y1, x, y);
								break;
							}		
						}
						switch (Tool) {
							case "Erase":
								canvas.style.cursor="none";
								ctx2.fillStyle="white";
								ctx2.strokeStyle="black";
								ctx2.lineWidth=1;
								ctx2.globalAlpha=1;
								DrawTempRect(x-25,y-25,x+25,y+25);
								if (mousedown==true) {
									ctx.clearRect(x-25,y-25,50,50);
								}
							break;
							case "Pic":
								canvas.style.cursor="none";
								pich=document.getElementById("pich");
								picw=document.getElementById("picw");
								if (pich.value!="") {
									ctx2.drawImage(image, x, y, picw.value, pich.value);
								} 
								else {
									ctx2.drawImage(image, x, y);
								}
							break;
							case "TextMove":
								canvas.style.cursor="none";
								DrawTempText(x,y, Text);						
							break;
							case "DotToDot":
								if (i!=0) {
									if (!dotgrab) {
										for (var z=0; z<i; z++) {
											if (x>pointarray[z][0]-4 && x<pointarray[z][0]+4 && y>pointarray[z][1]-4 && y<pointarray[z][1]+4) {
												if (mousedown==false) {
													canvas.style.cursor="move";
													canvas.style.cursor="-moz-grab";
												}
												else {
													canvas.style.cursor="move";
													canvas.style.cursor="-moz-grabbing";
													pointarray[z][0]=x;
													pointarray[z][1]=y;
													dotindex=z;
													dotgrab=true;
												}
											}
										}
									}
									else {
										canvas.style.cursor="move";
										canvas.style.cursor="-moz-grabbing";
										pointarray[dotindex][0]=x;
										pointarray[dotindex][1]=y;
									}
								}				
							break;
						}
					}
					canvas.onmousedown=function(e) {
						x1=x;
						y1=y;
						mousedown=true;
						if (Tool=="DotToDot") {
							for (var z=0; z<i; z++) {
								if (x>pointarray[z][0]-4 && x<pointarray[z][0]+4 && y>pointarray[z][1]-4 && y<pointarray[z][1]+3) {
									canvas.style.cursor="move";
									canvas.style.cursor="-moz-grabbing";
									if (e.button==2) {
										e.preventDefault();
										pointarray.splice(z,1);
										i--;
										mousedown=false;
										return false;
									}
								}
							}
						}
						return true;
					}
					canvas.onmouseup=function(e) {
						if (mousedown==false)
							return false;
						mousedown=false;
						canvas.style.cursor="";
						ClearTemp();
						UpdateSettings();
						switch (Tool) {
							case "FreeLine":
							case "Line": 
								DrawLine(x1, y1, x,y);				
							break;
							case "Circle":
								DrawCircle(x1, y1, x, y);
							break
							case "Rect":
								DrawRect(x1, y1, x, y);
								break;						
							case "Text":
								Text=null;
								Text=prompt("הקלד טקסט כאן",""); //FIXME: use something better then prompt here
								if (Text!=null && Text!="") {
									DrawTempText(x,y, Text);
									Tool="TextMove";
								}
								break;
							case "TextMove":
								DrawText(x,y, Text);
								SelectTool("Text");						
							break;
							case "Erase":
								ctx.clearRect(x-25,y-25,50,50);
							break;
							case "Pic":
								pich=document.getElementById("pich");
								picw=document.getElementById("picw");
								if (pich.value!="") {
									ctx.drawImage(image, x, y, picw.value, pich.value);
								} 
								else {
									ctx.drawImage(image, x, y);
								}
								SelectTool(ptool);
							break;
							case "Triangle":
								DrawTriangle(x1, y1, x, y);
							break;
							case "DotToDot":
								if (!dotgrab) {
									pointarray[i]=new Array(2);
									pointarray[i][0]=x;
									pointarray[i][1]=y;
									i++;
									ctx2.fillStyle="blue";
									ctx2.strokeStyle="black";
									ctx2.lineWidth=1;
									ctx2.globalAlpha=0.5;
									DrawTempRect(x-3,y-3,x+3,y+3);							
								}							
							break;
							}
						x1=-1;
						dotgrab=false;
						Save();
					}
					canvas.addEventListener("dragover", function(event) {
  						event.preventDefault();
					}, true);
					canvas.addEventListener("drop", function(event) {
  						event.preventDefault();
  						ptool=Tool;
						SelectTool("Pic");
						var dataURL = event.dataTransfer.files[0].getAsDataURL();
  						image = new Image();
						image.src=dataURL;
						ctx2.drawImage(image, x, y);
					}, true);
				}
				function ClearTemp() {
					ctx2.clearRect(0,0, canvas.width, canvas.height);
					for (var z=0; z<pointarray.length; z++) {
						ctx2.fillStyle="blue";
						ctx2.strokeStyle="black";
						ctx2.lineWidth=1;
						ctx2.globalAlpha=0.5;
						DrawTempRect(pointarray[z][0]-3,pointarray[z][1]-3,pointarray[z][0]+3,pointarray[z][1]+3);
					}
				}
				function UpdateSettings() {
					fill=document.getElementById("fill");
					stroke=document.getElementById("stroke");
					width=document.getElementById("linesize");
					alpha=document.getElementById("alpha");
					linecap=document.getElementById("round");
					if (fill.value!="") {
						ctx.fillStyle=fill.value;
						ctx2.fillStyle=fill.value;
					} else {
						ctx.fillStyle="transparent";
						ctx2.fillStyle="transparent";
					}
					if (stroke.value!="") {
						ctx.strokeStyle=stroke.value;
						ctx2.strokeStyle=stroke.value;
					} else {
						ctx.strokeStyle="black";
						ctx2.strokeStyle="black";
					}
					if (width.value!="") {
						ctx.lineWidth=width.value;
						ctx2.lineWidth=width.value;
					} else {
						ctx.lineWidth=1;
						ctx2.lineWidth=1;				
					}
					if (alpha.value!="") {
						ctx.globalAlpha=alpha.value;
						ctx2.globalAlpha=alpha.value;
					} else {
						ctx.globalAlpha=1;
						ctx2.globalAlpha=1;
					}
					if (linecap.checked==true && (Tool=="Line" || Tool=="FreeLine")) {
						ctx.lineCap = "round";
						ctx2.lineCap = "round";
					} else {
						ctx.lineCap = "butt";
						ctx2.lineCap = "butt";
					}
				
				}
				function touchHandler(event) {
					var touches = event.changedTouches,
					first = touches[0],
					type = "";
					switch(event.type) {
						case "touchstart": type = "mousedown"; break;
						case "touchmove":  type="mousemove"; break;        
						case "touchend":   type="mouseup"; break;
						default: return;
					}
					var simulatedEvent = document.createEvent("MouseEvent");
					simulatedEvent.initMouseEvent(type, true, true, window, 1,
							      first.screenX, first.screenY,
							      first.clientX, first.clientY, false,
							      false, false, false, 0/*left*/, null);

					first.target.dispatchEvent(simulatedEvent);
					event.preventDefault();
				}
				function DrawLine(x1,y1,x2,y2) {
					ctx.beginPath();  
					ctx.moveTo(x1,y1);  
					ctx.lineTo(x2,y2);
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempLine(x1,y1,x2,y2) {
					prevlineX=x2;
					prevlineY=y2;
					ctx2.beginPath();  
					ctx2.moveTo(x1,y1);  
					ctx2.lineTo(x2,y2);
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawCircle(x1, y1, x2, y2) {			
					radius=Math.abs(x1-x2)+Math.abs(y1-y2);
					ctx.beginPath();
					ctx.arc(x1, y1, radius, 0, (Math.PI/180)*360, false);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempCircle(x1, y1, x2, y2) {
					radius=Math.abs(x1-x2)+Math.abs(y1-y2);
					ctx2.beginPath();
					ctx2.arc(x1, y1, radius, 0, (Math.PI/180)*360, false);
					ctx2.fill();
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawRect(x1,y1,x2,y2) {
					ctx.beginPath();  
					ctx.moveTo(x1,y1);
					ctx.lineTo(x2, y1);
					ctx.lineTo(x2, y2);
					ctx.lineTo(x1, y2);
					ctx.lineTo(x1, y1);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempRect(x1,y1,x2,y2) {
					ctx2.beginPath();  
					ctx2.moveTo(x1,y1);
					ctx2.lineTo(x2, y1);
					ctx2.lineTo(x2, y2);
					ctx2.lineTo(x1, y2);
					ctx2.lineTo(x1, y1);
					ctx2.fill();
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawText(x, y, text) {
					font=document.getElementById("font").value;
					size=document.getElementById("size").value;
					if (font=="")
						font="sans-serif";
					if (size=="")
						size="10px";
					ctx.font=size+" "+font;
					ctx.beginPath();  
					ctx.strokeText(text, x,y);
					ctx.fillText(text, x,y);
					ctx.closePath();
				}
				function DrawTempText(x, y, text) {
					font=document.getElementById("font").value;
					size=document.getElementById("size").value;
					if (font=="")
						font="sans-serif";
					if (size=="")
						size="10px";
					ctx2.font=size+" "+font;
					ctx2.beginPath();  
					ctx2.strokeText(text, x,y);
					ctx2.fillText(text, x,y);
					ctx2.closePath();
				}
				function DrawTriangle(x1, y1,x2,y2) { //TODO: Other triangles, not just right triangle
					ctx.beginPath();  
					ctx.moveTo(x1,y1);
					ctx.lineTo(x2, y1);
					ctx.lineTo(x2, y2);
					ctx.lineTo(x1, y1);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();			
				}
				function DrawTempTriangle(x1, y1,x2,y2) {
					ctx2.beginPath();  
					ctx2.moveTo(x1,y1);
					ctx2.lineTo(x2, y1);
					ctx2.lineTo(x2, y2);
					ctx2.lineTo(x1, y1);
					ctx2.fill();
					ctx2.stroke();
					ctx2.closePath();			
				}
				function DotToDotDone() {
					if (i==0)
						return false;
					ctx.beginPath();
					ctx.moveTo(pointarray[0][0], pointarray[0][1]);
					for (var z=1; z<i; z++) {
						ctx.lineTo(pointarray[z][0], pointarray[z][1]);
					}
					ctx.lineTo(pointarray[0][0], pointarray[0][1]);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();
					pointarray=new Array();
					i=0;
					ClearTemp();
				}
				function DrawRandom(dots) {
					pointarray=new Array();
					ctx.globalAlpha=Math.random();
					for (var z=0; z<dots; z++) {
						var randX=Math.floor(Math.random()*canvas.width);
						var randY=Math.floor(Math.random()*canvas.height);
						pointarray[z]=new Array(2);
						pointarray[z][0]=randX;
						pointarray[z][1]=randY;
					}
					i=dots;
					DotToDotDone();
				}
				function Export() {
					DataURL=canvas.toDataURL("image/png");
					window.open(DataURL);
				}
				function Clear() {
					ctx.clearRect(0,0, canvas.width, canvas.height);
					i=0;
					pointarray=new Array();
					ClearTemp();
					localStorage.clear();
					Load();
				}
				function SelectTool(ToolName) {
					if (ToolName==null) 
						return false;
					fontsettings=document.getElementById("fontsettings");
					picsettings=document.getElementById("picsettings");
					linesettings=document.getElementById("linesettings");
					fontsettings.setAttribute("class", "settings");
					picsettings.setAttribute("class", "settings");
					linesettings.setAttribute("class", "settings");
					Tool=ToolName;
					MenuArray=document.getElementsByClassName("ToolMenuItem");
					for (var i=0; i<MenuArray.length;i++) {
						MenuArray[i].style.display="";
					}
					document.getElementById('tool').innerHTML=Tool;
					document.getElementById(ToolName).style.display="none";
					document.getElementById("dot2dotDone").style.visibility="hidden";
					switch(ToolName) {
						case "Text":
							fontsettings.setAttribute("class", "settingsVis");				
						break;
						case "Pic":
							picsettings.setAttribute("class", "settingsVis");
						break;
						case "FreeLine":
						case "Line":
							linesettings.setAttribute("class", "settingsVis");
						break;
						case "DotToDot":
							document.getElementById("dot2dotDone").style.visibility="";
						break;
					}				
				}
				function Save() {
					localStorage.setItem("CanvasState", canvas.toDataURL("image/png"));
				}
				function SaveSettings() { //Save settings to LocalStorage
					UpdateSettings();
					localStorage.setItem("Tool", Tool);
					fill=document.getElementById("fill").value;
					stroke=document.getElementById("stroke").value;
					width=document.getElementById("linesize").value;
					alpha=document.getElementById("alpha").value;
					linecap=document.getElementById("round").checked;
					localStorage.setItem("fill", fill);
					localStorage.setItem("stroke", stroke);
					localStorage.setItem("width", width);
					localStorage.setItem("alpha", alpha);
					localStorage.setItem("linecap", linecap);
				}
				function Load() { //Load settings from LocalStorage
					document.getElementById('position').innerHTML="Loading";			
					StoredCanvasState=localStorage.getItem("CanvasState");
					if (StoredCanvasState!=null) {
					  	image = new Image();
						image.src=StoredCanvasState;
						ctx.drawImage(image,0,0,canvas.width,canvas.height);
					}
					document.getElementById("fill").value=localStorage.getItem("fill");
					document.getElementById("stroke").value=localStorage.getItem("stroke");
					document.getElementById("linesize").value=localStorage.getItem("width");
					document.getElementById("alpha").value=localStorage.getItem("alpha");
					document.getElementById("round").checked=localStorage.getItem("linecap");
					SelectTool(localStorage.getItem("Tool"));
					UpdateSettings();
					document.getElementById('position').innerHTML="";			
				}
				function MenuAnimation() { //Animate menu
					Menu=document.getElementById("ToolMenu");
					if (Menu.getAttribute("class")=="ToolMenu") {
						document.getElementById("MenuTrigger").innerHTML="בחר כלי &#9652;"
						Menu.setAttribute("class", "ToolMenuVis");
					}
					else {
						Menu.setAttribute("class", "ToolMenu");
						document.getElementById("MenuTrigger").innerHTML="בחר כלי &#9662;"
					}
				}
				function ToggleSettings() {
					SettingsContainer=document.getElementById("SettingsContainer");
					if (SettingsContainer.getAttribute("class")=="hidden")
						SettingsContainer.setAttribute("class", "SettingsContainer");
					else
						SettingsContainer.setAttribute("class", "hidden");
				}
				function ToggleEval() {
					EvalContainer=document.getElementById("EvalContainer");
					if (EvalContainer.getAttribute("class")=="hidden")
						EvalContainer.removeAttribute("class");
					else
						EvalContainer.setAttribute("class", "hidden");
				}
		</script>
	</head>
	<body onload="init()">
		<div>
		<div class="ButtonContainer">
			<span onclick="ToggleSettings()">הגדרות</span><span onclick="Export()">ייצוא</span><span onclick="Clear()">ניקוי</span><span onclick="ToggleEval();" title="צייר באמצעות קוד JS">קוד</span><span id="dot2dotDone" onclick="DotToDotDone();" style="padding:10px; padding-top:5px; visibility: hidden;">סיימתי</span>
		</div>
		<div class="MenuContainer">
			<span id="MenuTrigger" onclick="MenuAnimation()" ontouchstart="MenuAnimation()">בחר כלי &#9662;</span>
			<div class="ToolMenu" id="ToolMenu">
				<div class="ToolMenuItem" id="FreeLine" onclick="SelectTool('FreeLine')" ontouchstart="SelectTool('FreeLine')">עיפרון</div>
				<div class="ToolMenuItem" id="Line" onclick="SelectTool('Line')" ontouchstart="SelectTool('Line')">קו</div>
				<div class="ToolMenuItem" id="Circle" onclick="SelectTool('Circle')" ontouchstart="SelectTool('Circle')">מעגל</div>
				<div class="ToolMenuItem" id="Rect" onclick="SelectTool('Rect')" ontouchstart="SelectTool('Rect')">מרובע</div>
				<div class="ToolMenuItem" id="Triangle" onclick="SelectTool('Triangle')" ontouchstart="SelectTool('Triangle')">משולש</div>
				<div class="ToolMenuItem" id="Text" onclick="SelectTool('Text')" ontouchstart="SelectTool('Text')">טקסט</div>
				<div class="ToolMenuItem" id="DotToDot" onclick="SelectTool('DotToDot')" ontouchstart="SelectTool('DotToDot')">dot2dot</div>
				<div class="ToolMenuItem" id="Erase" onclick="SelectTool('Erase')" ontouchstart="SelectTool('Erase')">מחק</div>
			</div>
		</div>
		<br>
		<div id="EvalContainer"  class="hidden">
			<input type="text" id="eval" placeholder="כתוב קוד ג'וואהסקריפט כאן" />
			<input type="button" onclick="eval(document.getElementById('eval').value);" value="הערך" />
		</div>
		<div class="hidden" id="SettingsContainer">
		<br>
		צבע הקו: <input id="stroke" type="color" placeholder="black" />
		<br>
		צבע המילוי: <input id="fill" type="color" placeholder="transparent" />
		<br>
		רוחב קו: <input id="linesize" type="number" placeholder="1" />
		<br>
		שקיפות גלובלית: <input id="alpha" type="number" placeholder="1" />
		<div id="fontsettings" class="settings">
		<br>
		גופן: <input id="font" type="text" placeholder="sans-serif" />
		<br>
		גודל הגופן: <input id="size" type="number" placeholder="10px" />
		</div>
		<div id="picsettings" class="settings">
		<br>
		גובה תמונה: <input id="pich" type="number" placeholder="default" />
		<br>
		רוחב תמונה: <input id="picw" type="number" placeholder="default" />
		</div>
		<div id="linesettings" class="settings">
		<br>
		קצוות עגולים: <input id="round" type="checkbox"/>
		</div>
		</div>
		<br>
		<span id="position"></span>&nbsp;
		<span id="tool"></span>
		</div>
		<div class="canvasLayers">
		<canvas id="TempLayer" class="layer" width="650" height="650"></canvas>
		<canvas id="canvas" class="layer" width="650" height="650">
	יש להשתמש בדפדפן תומך Canvas כדי להשתמש ביישום זה. ודאו שאתם משתמשים בגרסה העדכנית ביותר של הדפדפן שלכם, או עברו ל
			<a href="http://firefox.co.il">פיירפוקס</a>.
		</canvas>
		</div>
	</body>
</html>
