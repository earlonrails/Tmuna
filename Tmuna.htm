<!doctype html>
<html>
<!--
Tmuna (תמונה, Hebrew for "picture") is an open-sourced free HTML5 drawing application.
    Copyright (C) 2010  Elad Alfassa <elad@fedoraproject.org>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

Github: https://github.com/elad661/Tmuna
!-->
	<head>
		<title>תמונה: תוכנת ציור בHTML5</title>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				direction: rtl;			
			}
			canvas {
				border: 1px solid black;	
			}
			canvas.layer {
				position: absolute; 	
				right:4px; 
			}
			#TempLayer {
				pointer-events: none; 
				z-index: 1;		
			}
		</style>
		<script type="text/javascript">
				var canvas;
				var ctx;
				var image, ptool;
				var x=0, y=0;
				var x1=-1, y1=-1;
				var Tool="Line";
				var Color="black"
				var mousedown=false;
				var FColor="transparent";
				function init() {
			    	canvas = document.getElementById('canvas');
					TempLayer = document.getElementById('TempLayer'); 
  					if (canvas.getContext){	
 						ctx = canvas.getContext('2d');
						ctx2 = TempLayer.getContext('2d');
					} else {  
  						alert("אתה צריך דפדפן עדכני בשביל זה. מה, אתה גולש באקספלורר? איזה דביל! או שתחליף דפדפן או שתעוף מכאן. בחירה שלך."); 
					}
					canvas.onmouseout = function(e) {
						x1=-1;
						ClearTemp();				
					}
					canvas.onmousemove = function(e) {
						RefreshColors();
						ClearTemp();
						if (e.offsetX) { x = e.offsetX; y = e.offsetY; }
						else if (e.layerX) { x = e.layerX; y = e.layerY }
						document.getElementById('position').innerHTML="X: " + x+", Y: " +y;
						document.getElementById('tool').innerHTML=Tool;
						if (x1!=-1) {	
							switch(Tool) {					
								case "FreeLine":
									DrawLine(x1, y1, x,y);
									x1=x; y1=y;
								break;
								case "Line":
									DrawTempLine(x1, y1, x,y);
								break;
								case "Circle":
									DrawTempCircle(x1, y1, x, y);
								break;
								case "Rect":
									DrawTempRect(x1, y1, x, y);
								break;
							}		
						}
						switch (Tool) {
							case "Erase":
								var PFColor=FColor;
								var PColor=Color;
								FColor="white";
								Color="black";
								DrawTempRect(x-25,y-25,x+25,y+25);
								if (mousedown==true) {
									ctx.clearRect(x-25,y-25,50,50);
								}
								FColor=PFColor;
								Color=PColor;
							break;
							case "Pic":
								ctx2.drawImage(image, x, y);
							break;
						}
					}
					canvas.onmousedown=function(e) {
						x1=x;
						y1=y;
						mousedown=true;
					}
					canvas.onmouseup=function(e) {
						mousedown=false;
						ClearTemp();
						RefreshColors();
						switch (Tool) {
							case "FreeLine":
							case "Line": 
								DrawLine(x1, y1, x,y);				
							break;
							case "Circle":
								DrawCircle(x1, y1, x, y);
							break
							case "Rect":
								DrawRect(x1, y1, x, y);
								break;						
							case "Text":
								Text=prompt("הקלד טקסט כאן",""); //FIXME: use something better then prompt here
								DrawText(x,y, Text);
								break;
							case "Erase":
								ctx.clearRect(x-25,y-25,50,50);
							break;
							case "Pic":
								ctx.drawImage(image, x, y);
								Tool=ptool;
							break;
							}
						x1=-1;
					}
					canvas.addEventListener("dragover", function(event) {
  						event.preventDefault();
					}, true);
					canvas.addEventListener("drop", function(event) {
  						event.preventDefault();
  						//FIXME: First drop doesn't work. only second.
  						ptool=Tool;
						Tool="Pic"
						var dataURL = event.dataTransfer.files[0].getAsDataURL();
  						image = new Image();
						image.src=dataURL;
						ctx2.drawImage(image, x, y);
					}, true);
				}
				function ClearTemp() {
					ctx2.clearRect(0,0, 650, 650);
				}
				function RefreshColors() {
					fill=document.getElementById("fill");
					stroke=document.getElementById("stroke");
					if (fill.value!="")
						FColor=fill.value;
					if (stroke.value!="")					
						Color=stroke.value;	
				}
				function DrawLine(x1,y1,x2,y2) {
					ctx.strokeStyle=Color;
					ctx.beginPath();  
					ctx.moveTo(x1,y1);  
					ctx.lineTo(x2,y2);
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempLine(x1,y1,x2,y2) {
					ctx2.strokeStyle=Color;
					prevlineX=x2;
					prevlineY=y2;
					ctx2.beginPath();  
					ctx2.moveTo(x1,y1);  
					ctx2.lineTo(x2,y2);
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawCircle(x1, y1, x2, y2) {
					ctx.strokeStyle=Color;
					ctx.fillStyle=FColor;
					radius=(Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2)))/2;
					ctx.beginPath();
					ctx.arc(x1, y1, radius, 0, (Math.PI/180)*360, false);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempCircle(x1, y1, x2, y2) {
					ctx2.strokeStyle=Color;
					ctx2.fillStyle=FColor;
					radius=(Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2)))/2;
					ctx2.beginPath();
					ctx2.arc(x1, y1, radius, 0, (Math.PI/180)*360, false);
					ctx2.fill();
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawRect(x1,y1,x2,y2) {
					ctx.strokeStyle=Color;
					ctx.fillStyle=FColor;
					ctx.beginPath();  
					ctx.moveTo(x1,y1);
					ctx.lineTo(x2, y1);
					ctx.lineTo(x2, y2);
					ctx.lineTo(x1, y2);
					ctx.lineTo(x1, y1);
					ctx.fill();
					ctx.stroke();
					ctx.closePath();
				}
				function DrawTempRect(x1,y1,x2,y2) {
					ctx2.strokeStyle=Color;
					ctx2.fillStyle=FColor;
					ctx2.beginPath();  
					ctx2.moveTo(x1,y1);
					ctx2.lineTo(x2, y1);
					ctx2.lineTo(x2, y2);
					ctx2.lineTo(x1, y2);
					ctx2.lineTo(x1, y1);
					ctx2.fill();
					ctx2.stroke();
					ctx2.closePath();
				}
				function DrawText(x, y, text) {
					font=document.getElementById("font").value;
					size=document.getElementById("size").value;
					if (font=="")
						font="sans-serif";
					if (size=="")
						size="10px";
					ctx.font=size+" "+font;
					ctx.strokeStyle=Color;
					ctx.fillStyle=FColor;
					ctx.beginPath();  
					ctx.strokeText(text, x,y);
					ctx.closePath();
				}	
				function Export() {
					DataURL=canvas.toDataURL("image/png");
					window.open(DataURL);
				}
				function Clear() {
					ClearTemp();
					ctx.clearRect(0,0, 650, 650);
				}
		</script>
	</head>
	<body onload="init()">
		<div style="float:left">
		<input type="button" value="ייצוא" onclick="Export()">
		<input type="button" value="ניקוי" onclick="Clear()">
		<br><br>
		<input type="button" onclick="Tool='Line'" value="קו" />
		<input type="button" onclick="Tool='FreeLine'" value="עיפרון" />
		<input type="button" onclick="Tool='Circle'" value="מעגל" />
		<input type="button" onclick="Tool='Rect'" value="מרובע" />
		<input type="button" onclick="Tool='Text'" value="טקסט" />
		<input type="button" onclick="Tool='Erase'" value="מחק" />
		<br>
		צבע הקו: <input id="stroke" placeholder="black" />
		<br>
		צבע המילוי: <input id="fill" placeholder="transparent" />
		<div id="fontsettings">
		<br>
		גופן: <input id="font" placeholder="sans-serif" />
		<br>
		גודל הגופן: <input id="size" placeholder="10px" />
		</div>
		<br>
		<span id="position"></span>&nbsp;
		<span id="tool"></span>
		</div>
		<div class="canvasLayers">
		<canvas id="TempLayer" class="layer" width="650" height="650"></canvas>
		<canvas id="canvas" class="layer" width="650" height="650">
			יש להשתמש בדפדפן תומך Canvas כדי להשתמש ביישום זה. ודאו שאתם משתמשים בגרסה העדכנית ביותר של הדפדפן שלכם, או עברו לפיירפוקס.		
		</canvas>
		</div>
	</body>
</html>

